<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>fetch | Ge Yulong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="十多年来，我们一直使用XMLHttpRequest(XHR)来发送异步请求，XHR很实用，但并不是一个设计优良的API，在设计上并不符合职责分离原则，输入，输出及状态都杂糅在同一对象中，并用事件机制来跟踪状态变化。并且，基于事件的模型与最近流行的Promise 和 Generator 异步编程模型不太友好。">
<meta name="keywords" content="JavaScript,web,Promise">
<meta property="og:type" content="article">
<meta property="og:title" content="fetch">
<meta property="og:url" content="http://yulongge.github.io/2016/12/16/fetch/index.html">
<meta property="og:site_name" content="Ge Yulong">
<meta property="og:description" content="十多年来，我们一直使用XMLHttpRequest(XHR)来发送异步请求，XHR很实用，但并不是一个设计优良的API，在设计上并不符合职责分离原则，输入，输出及状态都杂糅在同一对象中，并用事件机制来跟踪状态变化。并且，基于事件的模型与最近流行的Promise 和 Generator 异步编程模型不太友好。">
<meta property="og:updated_time" content="2017-06-13T15:51:24.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="fetch">
<meta name="twitter:description" content="十多年来，我们一直使用XMLHttpRequest(XHR)来发送异步请求，XHR很实用，但并不是一个设计优良的API，在设计上并不符合职责分离原则，输入，输出及状态都杂糅在同一对象中，并用事件机制来跟踪状态变化。并且，基于事件的模型与最近流行的Promise 和 Generator 异步编程模型不太友好。">
  
    <link rel="alternate" href="/atom.xml" title="Ge Yulong" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Ge Yulong</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">web</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yulongge.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-fetch" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/16/fetch/" class="article-date">
  <time datetime="2016-12-16T09:44:22.000Z" itemprop="datePublished">2016-12-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>►<a class="article-category-link" href="/categories/web/JavaScript/">JavaScript</a>►<a class="article-category-link" href="/categories/web/JavaScript/Promise/">Promise</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      fetch
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>十多年来，我们一直使用XMLHttpRequest(XHR)来发送异步请求，XHR很实用，但并不是一个设计优良的API，在设计上并不符合职责分离原则，输入，输出及状态都杂糅在同一对象中，并用事件机制来跟踪状态变化。并且，基于事件的模型与最近流行的Promise 和 Generator 异步编程模型不太友好。<br><a id="more"></a><br>Fetch API 皆在修正上述缺陷，它提供了与HTTP语义相同的JS语法，简单来说，它引入了fetch()这个实用的方法来获取网络资源。</p>
<p>在Fetch规范中对API进行了定义，他结合ServiceWorkers，尝试做到如下优化</p>
<ol>
<li>修改离线体验</li>
<li>保持可扩展性</li>
</ol>
<p>此时Fetch API 已经被很多浏览器支持，在github也有相应的polyfill</p>
<h3 id="特征检查"><a href="#特征检查" class="headerlink" title="特征检查"></a>特征检查</h3><p>可以通过检查Headers, Request, Response 或 fetch 在window 或 worker 作用域中是否存在，来检查是否支持Fetch API。</p>
<h3 id="简单实例"><a href="#简单实例" class="headerlink" title="简单实例"></a>简单实例</h3><p>Fetch API中最常用的是fetch()方法，该方法最简单的形式是，接收一个url参数并返回以一个promise对象.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">fetch('/data.json').then(rep =&gt; &#123;</div><div class="line">  //res instanceof Response == true</div><div class="line">    if(res.ok)&#123;</div><div class="line">      res.json().then(() =&gt; &#123;</div><div class="line">          console.log(data.entries)</div><div class="line">      &#125;)</div><div class="line">    &#125; else &#123;</div><div class="line">      console.log('looks like the response wan't prefect, got status' + res.status)</div><div class="line">    &#125;</div><div class="line">&#125;, (e) =&gt; &#123;</div><div class="line">    console.log('Error is coming...')</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>如果提交一个POST请求<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">fetch(<span class="string">'submit.php'</span>, &#123;</div><div class="line">  <span class="attr">method</span>: <span class="string">'POST'</span>,</div><div class="line">  <span class="attr">headers</span>: &#123;</div><div class="line">    <span class="string">"content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">body</span>: <span class="string">'name=yulong&amp;sex=man'</span></div><div class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</div><div class="line">  <span class="keyword">if</span>(res.ok)&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Perfect! Your settings are saved !'</span>)</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(res.status == <span class="number">401</span>) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Oops ! Your are not authorized.'</span>)</div><div class="line">  &#125;</div><div class="line">  &#125;, e =&gt; &#123;</div><div class="line">   <span class="built_in">console</span>.log(<span class="string">'Error submiting form !'</span>)</div><div class="line">  &#125;)</div></pre></td></tr></table></figure></p>
<p><strong>fetch()</strong> 方法的参数和 <strong>Request()</strong> 构造函数的参数完全一致，所以你可以传任意复杂的参数来实现更强大的fetch()</p>
<h3 id="headers"><a href="#Headers" class="headerlink" title="Headers"></a>Headers</h3><p>  Fetch 引入了3个接口，分别是Headers, Request 和 Response。他们直接对应于HTTP中相应的概念，但是基于隐私和安全考虑，也有些区别，例如CORS规则以及保证cookies不能被第三方获取。</p>
<p>  Headers接口是一个简单的键值对：<br>  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> content = <span class="string">'Hello World'</span>;</div><div class="line"><span class="keyword">let</span> reqHeaders = <span class="keyword">new</span> Headers()</div><div class="line">reqHeaders.append(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>)</div><div class="line">reqHeaders.append(<span class="string">'Content-Length'</span>, content.length.toString())</div><div class="line">reqHeaders.append(<span class="string">'X-Custom-Header'</span>, <span class="string">'ProcessThisImmediately'</span>)</div></pre></td></tr></table></figure></p>
<p>  也可以给构造函数传一个多维度数组或者js字面量对象：<br>  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">reqHeaders = <span class="keyword">new</span> Headers(&#123;</div><div class="line">    <span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>,</div><div class="line">    <span class="string">'Content-Length'</span>: content.length.toString(),</div><div class="line">    <span class="string">'x-Custom-Header'</span>: <span class="string">'ProcessThisImmediately,'</span></div><div class="line">    &#125;)</div></pre></td></tr></table></figure></p>
<p>  Header的内容可被检索：<br>  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">console</span>.log(reqHeader.has(<span class="string">'Content-Type'</span>)) <span class="comment">//true</span></div><div class="line"><span class="built_in">console</span>.log(reqHeader.has(<span class="string">'Set-Cookie'</span>)) <span class="comment">//false</span></div><div class="line">reqHeaders.set(<span class="string">'Content-Type'</span>,<span class="string">'text/html'</span>)</div><div class="line">reqHeaders.append(<span class="string">'X-Custom-Header'</span>,<span class="string">'AnotherValue'</span>)</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(reqHeaders.get(<span class="string">'Content-Length'</span>)) <span class="comment">//1</span></div><div class="line"><span class="built_in">console</span>.log(reqHeaders.getAll(<span class="string">'X-Custom-Header'</span>)) <span class="comment">// ['ProcessThisImmediately', 'AnotherValue']</span></div><div class="line"></div><div class="line">reqHeaders.delete(<span class="string">'X-Custom-Header'</span>)</div><div class="line"><span class="built_in">console</span>.log(reqHeaders.getAll(<span class="string">'X-Custom-Header'</span>)) <span class="comment">//[]</span></div></pre></td></tr></table></figure></p>
<p>  一些操作只在ServiceWorkers中可用，但是这些API使得操作header更为方便。</p>
<p>  由于header可以在发送请求时被发送或在接收到相应时被接收，并规定了那些参数可写，所以在Headers对象中有一个guard属性，来制定哪些参数可以被改变。<br>  guard属性值：</p>
<ul>
<li>‘none’ ： 默认值</li>
<li>‘request’: Request.headers 对象只读</li>
<li>‘request-no-cors’: 在no-cors模式下，Request.headers对象只读</li>
<li>‘response’: Response.headers 对象只读</li>
<li>‘immutable’: 通常在ServiceWorkers中使用，所以Header对象都为只读</li>
</ul>
<p>例如当guard为request时，你将不能添加和修改header的Content-Length属性。</p>
<p>如果使用了一个不合法的HTTP Header 名，那么Headers的方法通常会抛出TypeError异常。如果不小心写入了一个只读属性，也会抛出一个TypeError异常。除此之外，失败了将不会抛出任何异常。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> res = Response.error()</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    res.headers.set(<span class="string">'Origin'</span>, <span class="string">'http://yulong.com'</span>)</div><div class="line">  &#125; <span class="keyword">catch</span>(e) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Cannot pretentd to be a bank!'</span>)</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h3 id="request"><a href="#Request" class="headerlink" title="Request"></a>Request</h3><p>通过构造一个Request对象来获取网络资源，构造函数需要 <strong>Url</strong>, <strong>method</strong>, 和 <strong>headers</strong> 参数，同时也可以提供请求体(body),请求模式(mode), credentials和 catch hints等参数。</p>
<p>最简单的形式如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> req = <span class="keyword">new</span> Request(<span class="string">'/index.html'</span>)</div><div class="line"><span class="built_in">console</span>.log(req.method)</div><div class="line">  <span class="built_in">console</span>.log(req.url)</div></pre></td></tr></table></figure></p>
<p>也可以将一个Request对象传给构造函数，这将返回该对象的一个副本(这与clone()方法不同)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> copy = <span class="keyword">new</span> Request(req)</div><div class="line">  <span class="built_in">console</span>.log(copy.method)</div><div class="line">  <span class="built_in">console</span>.log(copy.url)</div></pre></td></tr></table></figure>
<p>这种形式通常只在ServiceWorkers中使用。<br>除URL之外的参数只能通过第二个参数传递，该参数是一个键值对:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> uploadReq = <span class="keyword">new</span> Request(<span class="string">"/uploadImage"</span>, &#123;</div><div class="line">  <span class="attr">method</span>: <span class="string">"POST"</span>,</div><div class="line">  <span class="attr">headers</span>: &#123;</div><div class="line">    <span class="string">"Content-Type"</span>: <span class="string">'image/png'</span>,</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">body</span>: <span class="string">"image data"</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>mode参数用来决定是否允许跨域请求，以及哪些response属性可读。可选的mode值为”same-origin”, “no-cors”(默认)以及”cors”.</p>
<ul>
<li><p>same-origin<br>该模式很简单，如果一个请求是跨域，那么将返回一个error，这样确保所有的请求遵守同源策略。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> arbitraryUrl = <span class="built_in">document</span>.getElementById(<span class="string">'url-input'</span>).value</div><div class="line">fetch(arbitraryUrl, &#123; <span class="attr">mode</span>: <span class="string">'same-origin'</span> &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Response succeeden ?'</span>, res.ok)</div><div class="line">&#125;, e =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Please enter a same-origin URL!'</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
</li>
<li><p>该模式通常用于跨域请求，用来从第三方提供的API获取数据。该模式遵守CORS协议，并只有有限的一些Header被暴露给Response对象，但是body是可读的。例如，获取一个Flick最感兴趣的照片清单：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> u = <span class="keyword">new</span> URLSearchParams()</div><div class="line">u.append(<span class="string">'method'</span>, <span class="string">'flicker.interestingness.getList'</span>)</div><div class="line">u.append(<span class="string">'api_key'</span>, <span class="string">'cinsert api key here'</span>)</div><div class="line">u.append(<span class="string">'format'</span>, <span class="string">'json'</span>)</div><div class="line">u.append(<span class="string">'nojsoncallback'</span>, <span class="string">'1'</span>)</div><div class="line"></div><div class="line"><span class="keyword">let</span> apiCall = fetch(<span class="string">'https://api.flickr.com/services/rest?'</span> + u)</div><div class="line"></div><div class="line">apiCall.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> res.json().then(<span class="function"><span class="params">json</span> =&gt;</span> &#123;</div><div class="line">          <span class="keyword">return</span> json.photos.photo</div><div class="line">        &#125;)</div><div class="line">    &#125;).then( <span class="function"><span class="params">photos</span> =&gt;</span> &#123;</div><div class="line">    photos.forEach(<span class="function"><span class="params">photo</span> =&gt;</span> &#123;</div><div class="line">      <span class="built_in">console</span>.log(photo.title)</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>你将无法从Headers中读取Date属性，因为Flicker在Access-Control-Expose-Headers中设置了不允许读取它。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">response.headers.get(<span class="string">'Date'</span>) <span class="comment">//null</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>credentials属性决定了是否可以跨域访问cookie。该属性与XHR的withCredentials标志相同，但是只有三个值：</p>
<ul>
<li>omit (默认)</li>
<li>same-origin </li>
<li>include</li>
</ul>
<p>Request对象也提供了客户端缓存机制(aching hints).这个属性还在安全复审阶段。Firefox提供了这个属性，但是目前还不起作用</p>
<p>Request对象还有两个与ServiceWorks拦截有关的只读属性。其中一个是referrer，表示该Request的来源，可能为空。另一个是context，一个非常大的枚举集合，定义了获得的资源种类，可能是image，当请求来自于img<br>标签时，可能是worker如果一个Worker脚本，等等等。如果用fetch()函数，这个值是fetch。</p>
<h3 id="response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><hr>
<p>Response对象通常在fetch()的回调中获得，也可以通过JS构造，不过这通常只是ServiceWorkers中使用。</p>
<p>Response对象中最常见的属性：</p>
<ul>
<li>status:整数默认值是200, 值的范围为200 ~ 299</li>
<li>statusText 默认值”ok”</li>
<li>type，他的值<ul>
<li>basic: 同域的响应，出Set-Cookie和Set-Cookie2之外的所有Header可用</li>
<li>cors: Response从一个合法的跨域请求获得，某些Header和body可读</li>
<li>error: 网络错误。Response对象的status属性为0，headers属性为空并且不可写。当Response对象从Response.error()总得到时，就是这种类型。当type值为’error’时会导致fetch()方法的Promise被reject，reject回调的参数为TypeError对象。</li>
<li>opaque: 在’no-cors’模式下请求了跨域资源</li>
</ul>
</li>
</ul>
<h3 id="body"><a href="#body" class="headerlink" title="body"></a>body</h3><p>  在Request 和 Response 对象中都可能有body 属性，并且body可以是各种类型，比较复杂。<br>  body可以是以下任何一种类型的实例：</p>
<ul>
<li>ArrayBuffer</li>
<li>ArrayBufferView</li>
<li>Blob/File</li>
<li>string</li>
<li>URLSearchParams</li>
<li>FormData</li>
</ul>
<p>此外Request 和 Response 都为操作body提供了一下方法(这些方法都返回一个使用实际内容resolve 的Promise对象):</p>
<ul>
<li>arrayBuffer()</li>
<li>blob()</li>
<li>json()</li>
<li>text()</li>
<li><p>formData()</p>
<p>所以在处理非文本的数据方面，Fetch API比XHR更为便利。</p>
</li>
</ul>
<p>设置请求实体：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> form = <span class="keyword">new</span> FormData(<span class="built_in">document</span>.getElementById(<span class="string">'login-form'</span>));</div><div class="line">fetch(<span class="string">"/login"</span>, &#123;</div><div class="line">  <span class="attr">method</span>: <span class="string">"POST"</span>,</div><div class="line">  <span class="attr">body</span>: form</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>Response 构造函数的第一个参数是响应体：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> res = <span class="keyword">new</span> Response(<span class="keyword">new</span> File([<span class="string">"chunk"</span>, <span class="string">"chunk"</span>], <span class="string">"archive.zip"</span>,</div><div class="line">&#123;<span class="attr">type</span>: <span class="string">"application/zip"</span>&#125;)                  	</div><div class="line">);</div></pre></td></tr></table></figure></p>
<p>Request 和 Response都能够自动识别自己的内容类型，Request 还可以自动设置 Content-Type 头，如果开发者没有设置它的话。</p>
<h3 id="流和克隆"><a href="#流和克隆" class="headerlink" title="流和克隆"></a>流和克隆</h3><p>非常重要的一点是，Request 和 Response 的 body 只能被读取一次！它们有一个属性叫 bodyUsed，读取一次之后设置为 true，之后就不能再被读取了。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> res = <span class="keyword">new</span> Response(<span class="string">"one time use"</span>);</div><div class="line"><span class="built_in">console</span>.log(res.bodyUsed); <span class="comment">// false</span></div><div class="line">res.text().then(<span class="function"><span class="keyword">function</span>(<span class="params">v</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(res.bodyUsed); <span class="comment">// true</span></div><div class="line">&#125;);</div><div class="line"><span class="built_in">console</span>.log(res.bodyUsed); <span class="comment">// true</span></div><div class="line"> </div><div class="line">res.text().catch(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"Tried to read already consumed Response"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>这样设计的目的是为了之后兼容基于流的 API，我们的目的是当数据到达时就进行相应的处理，这样就使得 JavaScript 可以处理大文件例如视频，并且可以支持实时压缩和编辑。<br>有时候，我们希望能多次访问 body，例如，你可能想使用即将支持的 Cache API 来缓存 Request 和 Response，以便于可以离线使用，Cache 要求 body 能被再次读取。<br>那么，如何让 body 能被多次读取呢？API 为这两个对象提供了一个 clone() 方法。调用这个方法可以得到一个克隆对象，对象中包含全新的 body。不过要记得，clone() 必须要在使用 body 之前调用，也就是先 clone() 再读使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">addEventListener(<span class="string">'fetch'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> sheep = <span class="keyword">new</span> Response(<span class="string">"Dolly"</span>);</div><div class="line">  <span class="built_in">console</span>.log(sheep.bodyUsed); <span class="comment">// false</span></div><div class="line">  <span class="keyword">var</span> clone = sheep.clone();</div><div class="line">  <span class="built_in">console</span>.log(clone.bodyUsed); <span class="comment">// false</span></div><div class="line"> </div><div class="line">  clone.text();</div><div class="line">  <span class="built_in">console</span>.log(sheep.bodyUsed); <span class="comment">// false</span></div><div class="line">  <span class="built_in">console</span>.log(clone.bodyUsed); <span class="comment">// true</span></div><div class="line"> </div><div class="line">  evt.respondWith(cache.add(sheep.clone()).then(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> sheep;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yulongge.github.io/2016/12/16/fetch/" data-id="cj4p6o4mm000xj4s6kz4z54di" class="article-share-link">Share</a>
      
        <a href="http://yulongge.github.io/2016/12/16/fetch/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Promise/">Promise</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/">web</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/12/19/iTerm2/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          iTerm2
        
      </div>
    </a>
  
  
    <a href="/2016/12/16/WebAPI/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">WebAPI</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Event/">Event</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JSON/">JSON</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/web/">web</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/web/JSONP/">JSONP</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Javascript/">Javascript</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Javascript/ES6/">ES6</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Javascript/ES6/Promise/">Promise</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/book/">book</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/http/https/">https</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/iTerm2/">iTerm2</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mvvm/">mvvm</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/mvvm/mvc/">mvc</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/mvvm/mvc/mvp/">mvp</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/vim/">vim</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/JavaScript/">JavaScript</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/JavaScript/Promise/">Promise</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/JavaScript/css/">css</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/webpack/">webpack</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Context/">Context</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cookie/">Cookie</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DOM/">DOM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Event/">Event</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSON/">JSON</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSONP/">JSONP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JvaScript/">JvaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Promise/">Promise</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RegExp/">RegExp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scope/">Scope</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Storage/">Storage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/URI/">URI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/book/">book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/event/">event</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/">https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iTerm2/">iTerm2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvc/">mvc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvp/">mvp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvvm/">mvvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/">npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ruanyifeng/">ruanyifeng</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/study/">study</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/this/">this</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Context/" style="font-size: 10px;">Context</a> <a href="/tags/Cookie/" style="font-size: 10px;">Cookie</a> <a href="/tags/DOM/" style="font-size: 10px;">DOM</a> <a href="/tags/ES6/" style="font-size: 10px;">ES6</a> <a href="/tags/Event/" style="font-size: 10px;">Event</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/JSON/" style="font-size: 10px;">JSON</a> <a href="/tags/JSONP/" style="font-size: 10px;">JSONP</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/JvaScript/" style="font-size: 10px;">JvaScript</a> <a href="/tags/Promise/" style="font-size: 12.5px;">Promise</a> <a href="/tags/RegExp/" style="font-size: 12.5px;">RegExp</a> <a href="/tags/Scope/" style="font-size: 10px;">Scope</a> <a href="/tags/Storage/" style="font-size: 10px;">Storage</a> <a href="/tags/URI/" style="font-size: 12.5px;">URI</a> <a href="/tags/book/" style="font-size: 17.5px;">book</a> <a href="/tags/css/" style="font-size: 10px;">css</a> <a href="/tags/event/" style="font-size: 10px;">event</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/iTerm2/" style="font-size: 10px;">iTerm2</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/mvc/" style="font-size: 10px;">mvc</a> <a href="/tags/mvp/" style="font-size: 10px;">mvp</a> <a href="/tags/mvvm/" style="font-size: 10px;">mvvm</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/npm/" style="font-size: 10px;">npm</a> <a href="/tags/ruanyifeng/" style="font-size: 17.5px;">ruanyifeng</a> <a href="/tags/study/" style="font-size: 10px;">study</a> <a href="/tags/this/" style="font-size: 12.5px;">this</a> <a href="/tags/vim/" style="font-size: 12.5px;">vim</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/tags/前端/" style="font-size: 10px;">前端</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/07/04/studyInsight/">学习心得</a>
          </li>
        
          <li>
            <a href="/2017/06/13/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2017/01/24/this/">this</a>
          </li>
        
          <li>
            <a href="/2017/01/23/npm/">从头开始写一个npm包</a>
          </li>
        
          <li>
            <a href="/2017/01/17/StringAPI/">String API</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Ge Yulong<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'yulongge-github-io';
  
  var disqus_url = 'http://yulongge.github.io/2016/12/16/fetch/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>